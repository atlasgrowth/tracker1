<!-- Add this right before closing </body> tag -->
<script>
  // Get the business ID from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const siteId = urlParams.get('site_id');

  if (siteId) {
    // Record visit and update pipeline stage
    const PIPELINE_URL = 'https://bbd5027a-f3b6-48cb-b2e3-7c31fdf9c394-00-1a4b9g7vepksy.janeway.replit.dev';

    // Send visit data when page unloads
    window.addEventListener('beforeunload', async () => {
      try {
        await fetch(`${PIPELINE_URL}/api/businesses/${siteId}/visits`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            duration: 0,
            source: document.referrer || 'direct'
          })
        });
      } catch (e) {
        console.error('Failed to record visit:', e);
      }
    });
  }
</script>